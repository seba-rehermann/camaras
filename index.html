<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>C√°maras Tomograf√≠a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-size: 0.85rem; background-color: #f4f7f6; }
        .table th, .table td { vertical-align: middle; padding: 6px 8px; }
        #reloj-central { font-family: monospace; font-weight: bold; font-size: 1.5rem; color: #2c3e50; background: #fff; padding: 5px 20px; border-radius: 8px; border: 2px solid #007bff; }
        .espera-inyectado td { background-color: #fff9c4 !important; color: #856404 !important; }
        .alerta-int { animation: titileo 1s infinite; font-weight: bold; border-radius: 4px; padding: 2px; }
        @keyframes titileo { 0% { background-color: #ffcccc; color: #cc0000; } 50% { background-color: #ff0000; color: white; } 100% { background-color: #ffcccc; color: #cc0000; } }
        .card-camara { border-radius: 10px; border: none; min-height: 70px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cam-libre { background-color: #d4edda; color: #155724; border-left: 6px solid #28a745; }
        .cam-ocupada { background-color: #f8d7da; color: #721c24; border-left: 6px solid #dc3545; }
        .selector-hora { display: flex; gap: 2px; align-items: center; background: #fff; padding: 2px 5px; border-radius: 6px; border: 1px solid #ced4da; }
        .sel-custom { width: 68px !important; font-weight: bold; border: none !important; background-color: transparent !important; }
        .btn-bloqueado { pointer-events: none; opacity: 0.6; filter: grayscale(1); background-color: #6c757d !important; color: white !important; border: none; }
    </style>
</head>
<body class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold text-primary m-0">TABLERO DE CONTROL - TOMOGRAF√çA</h5>
        <div id="reloj-central">00:00:00</div>
        <div>
            <a href="/vaciar" class="btn btn-sm btn-outline-danger" onclick="if(confirm('‚ö†Ô∏è ¬°ATENCI√ìN! Est√° a punto de borrar todos los registros del d√≠a. ¬øDesea continuar?')){ let pass = prompt('Ingrese clave (123) para confirmar:'); if(pass === '123') { return true; } else { alert('Clave incorrecta. No se borr√≥ nada.'); return false; } } else { return false; }">üßπ Limpiar</a>
        </div>
    </div>

    {% set camaras_ocupadas = [] %}
    {# Primero identificamos qu√© c√°maras est√°n en uso #}
    {% for r in registros %}
        {% if r.hora_entrada and not r.hora_salida %}
            {% set _ = camaras_ocupadas.append(r.camara|string) %}
        {% endif %}
    {% endfor %}

    <div class="row g-2 mb-3 text-center">
        {% for i in range(1, 5) %}
            {% set cam_id = i|string %}
            {% set p_act = namespace(n=none) %}
            {% for r in registros if r.camara == cam_id and r.hora_entrada and not r.hora_salida %}
                {% set p_act.n = r.nombre %}
            {% endfor %}
            <div class="col-3">
                <div class="card p-2 card-camara {{ 'cam-ocupada' if p_act.n else 'cam-libre' }}">
                    <div class="small fw-bold">C√ÅMARA {{ i }}</div>
                    <div class="small text-truncate text-uppercase fw-bold">{{ p_act.n if p_act.n else 'DISPONIBLE' }}</div>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <div class="card mb-4 p-3 bg-light border-0 shadow-sm">
        <form action="/guardar" method="POST" class="row gx-2 gy-2 align-items-end">
            <div class="col-auto">
                <label class="small fw-bold d-block mb-1 text-muted text-center">LLEGADA</label>
                <div class="selector-hora">
                    <select name="h_llegada" id="sel-h" class="form-select form-select-sm sel-custom"></select>
                    <span class="fw-bold">:</span>
                    <select name="m_llegada" id="sel-m" class="form-select form-select-sm sel-custom"></select>
                </div>
            </div>
            <div class="col">
                <label class="small fw-bold d-block mb-1 text-muted">PACIENTE</label>
                <input type="text" name="nombre" class="form-control form-control-sm" placeholder="Nombre completo" required>
            </div>
            <div class="col-auto">
                <label class="small fw-bold d-block mb-1 text-muted">PROC.</label>
                <input list="proc" name="procedencia" class="form-control form-control-sm" style="width: 80px;" placeholder="INT/AMB">
                <datalist id="proc"><option value="INT"><option value="AMB"></datalist>
            </div>
            <div class="col-auto">
                <label class="small fw-bold d-block mb-1 text-muted">ESTUDIO</label>
                <input type="text" name="estudio" class="form-control form-control-sm" style="width: 110px;" placeholder="Estudio">
            </div>
            <div class="col-auto">
                <label class="small fw-bold d-block mb-1 text-muted">C√ÅMARA</label>
                <select name="camara" class="form-select form-select-sm" style="width: 90px;">
                    <option value="1">Cam 1</option><option value="2">Cam 2</option><option value="3">Cam 3</option><option value="4">Cam 4</option>
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-success px-4 fw-bold shadow-sm">REGISTRAR</button>
            </div>
        </form>
    </div>

    <table class="table table-sm table-striped text-center bg-white shadow-sm border">
        <thead class="table-dark">
            <tr>
                <th>Llegada</th><th>Paciente</th><th>Proc.</th><th>Estudio</th><th>Inyecci√≥n</th><th>Cam</th><th>Entrada</th><th>Salida</th><th>‚è±Ô∏è Tiempo</th><th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for r in registros %}
            <tr class="{{ 'espera-inyectado' if r.hora_inyeccion and not r.hora_entrada else '' }}">
                <td class="fw-bold">{{ r.hora_llegada }}</td>
                <td class="text-start">{{ r.nombre }}</td>
                <td><span class="{{ 'alerta-int' if r.procedencia == 'INT' else '' }}">{{ r.procedencia }}</span></td>
                <td>{{ r.estudio }}</td>
                <td>
                    {% if not r.hora_inyeccion %}
                        <a href="/inyectar/{{ r.id }}" class="btn btn-xs btn-outline-success py-0 px-2" style="font-size: 0.7rem;">üíâ INYECTAR</a>
                    {% else %}
                        <span class="text-success fw-bold">üíâ {{ r.hora_inyeccion }}</span>
                    {% endif %}
                </td>
                <td><span class="badge bg-secondary">C-{{ r.camara }}</span></td>
                <td>
                    {% if not r.hora_entrada %}
                        {% if r.camara|string in camaras_ocupadas %}
                            <button class="btn btn-xs btn-bloqueado py-0 px-2" style="font-size: 0.7rem;">OCUPADA</button>
                        {% else %}
                            <a href="/entrar/{{ r.id }}" class="btn btn-xs btn-primary py-0 px-2" style="font-size: 0.7rem;">‚ñ∂ INICIAR</a>
                        {% endif %}
                    {% else %}
                        <span class="text-primary fw-bold">{{ r.hora_entrada }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if r.hora_entrada and not r.hora_salida %}
                        <a href="/salir/{{ r.id }}" class="btn btn-xs btn-danger py-0 px-2" style="font-size: 0.7rem;">‚ñ† TERMINAR</a>
                    {% else %}
                        <span class="text-danger fw-bold">{{ r.hora_salida if r.hora_salida else '' }}</span>
                    {% endif %}
                </td>
                <td class="tiempo-activo" data-entrada="{{ r.hora_entrada }}" data-salida="{{ r.hora_salida }}">---</td>
                <td>
                    <div class="d-flex justify-content-center gap-2">
                        <a href="/editar/{{ r.id }}" class="text-warning text-decoration-none">‚úèÔ∏è</a>
                        <a href="/eliminar/{{ r.id }}" class="text-danger text-decoration-none" onclick="if(confirm('‚ö†Ô∏è ¬°ATENCI√ìN! Est√° a punto de borrar todos los registros del d√≠a. ¬øDesea continuar?')){ let pass = prompt('Ingrese clave (123) para confirmar:'); if(pass === '123') { return true; } else { alert('Clave incorrecta. No se borr√≥ nada.'); return false; } } else { return false; }">üóëÔ∏è</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        const selH = document.getElementById('sel-h');
        const selM = document.getElementById('sel-m');
        const ahora_init = new Date();
        for(let i=0; i<24; i++) {
            let opt = document.createElement('option');
            opt.value = opt.text = i.toString().padStart(2, '0');
            if(i === ahora_init.getHours()) opt.selected = true;
            selH.add(opt);
        }
        for(let i=0; i<60; i++) {
            let opt = document.createElement('option');
            opt.value = opt.text = i.toString().padStart(2, '0');
            if(i === ahora_init.getMinutes()) opt.selected = true;
            selM.add(opt);
        }

        function actualizar() {
            const ahora = new Date();
            document.getElementById('reloj-central').innerText = ahora.toLocaleTimeString('es-ES', {hour12:false});
            document.querySelectorAll('.tiempo-activo').forEach(celda => {
                const hE = celda.dataset.entrada; const hS = celda.dataset.salida;
                if (hE && hE !== 'None' && hE !== '') {
                    const [h, m] = hE.split(':'); const ini = new Date(); ini.setHours(h, m, 0, 0);
                    let fin = ahora;
                    if (hS && hS !== 'None' && hS !== '') { const [sh, sm] = hS.split(':'); fin = new Date(); fin.setHours(sh, sm, 0, 0); }
                    let d = fin - ini; if (d < 0) d += 86400000;
                    celda.innerText = Math.floor(d/60000) + 'm ' + (hS && hS !== 'None' ? '' : Math.floor((d%60000)/1000) + 's');
                }
            });
        }
        setInterval(actualizar, 1000); actualizar();
        setInterval(() => { if (!document.querySelector('input:focus')) location.reload(); }, 60000);
    </script>
</body>
</html>
